name: CI/CD - Streamlit App

on:
  workflow_dispatch:
    inputs:
      logLevel:
        description: 'Log level'
        required: true
        default: 'warning'
        type: choice
        options:
        - info

  push:
    paths-ignore:
      - '.github/**'
      - 'api/**'
      - 'etl/**'
      - 'prefect/**'
      - 'terraform/**'
      - 'CHANGELOG.md'
      - '.gitignore'
      - '.prefectignore'
      - '.pre-commit-config.yaml'
      - 'pyproject.toml'
      - 'README.md'
    branches:
      - "main"
        
env:
  GAR_LOCATION: us-central1
  VERSION_NUMBER: '3.1.0'
  CLOUD_BUCKET: ${{ secrets.CLOUD_BUCKET }}
  CLOUD_SQL_INSTANCE: ${{ secrets.CLOUD_SQL_INSTANCE }}
  DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
  DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
  EMAIL: ${{ secrets.EMAIL }}
  NAME: ${{ secrets.NAME }}
  PROJECT_ID: ${{ secrets.PROJECT_ID }}
  REGISTRY_REPO: ${{ secrets.REGISTRY_REPO }}
  SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
  WIF_PROVIDER: ${{ secrets.WIF_PROVIDER }}
  WIF_SERVICE_ACCOUNT_ARTIFACT_REGISTRY: ${{ secrets.WIF_SERVICE_ACCOUNT_ARTIFACT_REGISTRY }}
  
jobs:

  build-streamlit-image:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
        
      - name: Prepare Docker Build Context
        run: |
          mkdir docker-context
          mkdir docker-context/.streamlit
          cp ./.dockerignore docker-context
          cp ./Dockerfile docker-context
          cp ./streamlit_app.py docker-context
          cp ./requirements.txt docker-context
          cp -r ./.streamlit/config.toml docker-context/.streamlit
        
      - name: Build and Export
        uses: docker/build-push-action@v4
        with:
          context: ./docker-context
          tags: streamlit:${{ env.VERSION_NUMBER }}
          outputs: type=docker, dest=/tmp/streamlit.tar
          platforms: linux/amd64, linux/arm64
          
      - name: Upload Artifact
        uses: actions/upload-artifact@v3
        with:
          name: streamlit
          path: /tmp/streamlit.tar

  push-docker-hub:
    runs-on: ubuntu-latest
    needs: [build-streamlit-image]
    if: |
      always() &&
      (needs.build-streamlit-image.result == 'success')
    steps:
  
    - name: Checkout
      uses: actions/checkout@v3

    - name: Login to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ env.DOCKERHUB_USERNAME }}
        password: ${{ env.DOCKERHUB_TOKEN }}

    - name: Download Artifact
      uses: actions/download-artifact@v3
      with:
        name: streamlit
        path: /tmp
        
    - name: Load Image
      run: |
        docker load --input /tmp/streamlit.tar
        docker image ls -a

    - name: Tag Image
      run: |
        docker tag \
        streamlit:${{ env.VERSION_NUMBER }} \
        ${{ env.DOCKERHUB_USERNAME }}/premier-league:latest

    - name: Push Image
      run: |
        docker push \
        ${{ env.DOCKERHUB_USERNAME }}/premier-league:latest
          
  push-artifact-registry:
    permissions:
      contents: 'read'
      id-token: 'write'
      
    runs-on: ubuntu-latest
    needs: [build-streamlit-image]
    if: |
      always() &&
      (needs.build-streamlit-image.result == 'success')
    steps:
    
      - name: Checkout
        uses: actions/checkout@v3
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
    
      - name: Download Artifact
        uses: actions/download-artifact@v3
        with:
          name: streamlit
          path: /tmp
          
      - name: Google Auth
        id: auth
        uses: 'google-github-actions/auth@v1'
        with:
          token_format: 'access_token'
          workload_identity_provider: '${{ env.WIF_PROVIDER }}'
          service_account: '${{ env.WIF_SERVICE_ACCOUNT_ARTIFACT_REGISTRY }}'
          project_id: '${{ env.PROJECT_ID }}'
          
      - name: Docker Auth
        id: docker-auth
        uses: 'docker/login-action@v2'
        with:
          username: 'oauth2accesstoken'
          password: '${{ steps.auth.outputs.access_token }}'
          registry: '${{ env.GAR_LOCATION }}-docker.pkg.dev'
        
      - name: Load Image
        run: |
          docker load --input /tmp/streamlit.tar
          docker image ls -a
          
      - name: Tag Image
        run: |
          docker tag \
          streamlit:${{ env.VERSION_NUMBER }} \
          "${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REGISTRY_REPO }}/streamlit:${{ env.VERSION_NUMBER }}"
          
      - name: Push Image
        run: |
          docker push \
          "${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REGISTRY_REPO }}/streamlit:${{ env.VERSION_NUMBER }}"
          
  deploy-streamlit-image:
    permissions:
      contents: 'read'
      id-token: 'write'
    
    runs-on: ubuntu-latest
    needs: [push-artifact-registry]
    if: |
      always() &&
      (needs.push-artifact-registry.result == 'success')
      
    steps:
    
      - name: Checkout
        uses: actions/checkout@v3
      
      - name: Google Auth
        id: auth
        uses: 'google-github-actions/auth@v1'
        with:
          token_format: 'access_token'
          workload_identity_provider: '${{ env.WIF_PROVIDER }}'
          service_account: '${{ env.WIF_SERVICE_ACCOUNT_ARTIFACT_REGISTRY }}'
          project_id: '${{ env.PROJECT_ID }}'
          
      - name: Deploy Image
        id: 'deploy'
        uses: 'google-github-actions/deploy-cloudrun@v1'
        with: 
          service: streamlit
          image: "${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REGISTRY_REPO }}/streamlit:${{ env.VERSION_NUMBER }}"
          secrets: /app/.streamlit/secrets.toml=streamlit-secret:latest
          flags: "--add-cloudsql-instances=${{ env.CLOUD_SQL_INSTANCE }}"
        
